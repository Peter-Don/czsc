# 融合缠论与SMC的量化交易体系：架构设计与实现蓝图

## 摘要

本报告旨在为一套融合缠论（Chanlun Theory）、智能货币概念（Smart Money Concepts, SMC）及内部圈子交易者（Inner Circle Trader, ICT）理论的新型量化交易体系，提供一份全面、详尽的架构设计与实现蓝un图。报告遵循“高内聚、低耦合”的软件工程最佳实践，旨在解决理论融合过程中的关键挑战，包括对核心价格行为的量化定义、形态模式的算法识别、多周期分析框架的构建，以及统一的入场、出场与融合评分系统。本文档的目标是为高级量化开发人员提供一个可直接用于工程实现的、逻辑严谨且细节丰富的技术规范。

## 第一部分：系统架构与基础组件API

### 1.1 架构哲学：算法交易中的高内聚与低耦合

在构建复杂的多理论融合量化交易系统时，“高内聚、低耦合”（高聚低耦）原则不仅是软件工程的最佳实践，更是确保系统稳定性、可扩展性与可维护性的核心基石。

#### 高内聚 (High Cohesion)：

指每个模块都应专注于执行一个单一且明确定义的任务。例如，一个专门负责处理缠论“笔”结构的模块，其内部逻辑应仅与“笔”的定义、识别和验证相关。这种设计使得模块功能清晰，易于理解、测试和优化。当缠论的“笔”算法需要从“老笔”升级到“新笔”时，修改将仅限于该模块内部，不会对其他模块（如SMC的订单块识别模块）产生不可预见的副作用 。  

#### 低耦合 (Low Coupling)：

指模块之间应保持最小的相互依赖性。模块间的交互应通过定义良好且稳定的接口（API）进行。例如，SMC分析引擎不应直接访问K线原始数据，而应接收由数据预处理模块和缠论结构引擎生成的标准化数据结构（如处理完包含关系的K线、笔、段等）。这种解耦允许各模块独立开发、并行测试和灵活替换。若未来决定引入新的分析理论（如市场剖面），可以将其封装为一个新模块，通过API与现有系统集成，而无需重构整个系统。



遵循此哲学，本系统被设计为一系列独立的、可插拔的模块，它们通过标准化的数据流进行通信。这种架构不仅提升了系统的鲁棒性，也为未来的策略迭代和优化提供了极大的灵活性。



#### 系统架构高级框图:

[数据接入层] -> [缠论引擎 (ChanlunEngine)] -> -> -> -> -> [执行管理器 (ExecutionManager)]



### 1.2 API设计：缠论结构模块 (ChanlunEngine)

此模块的核心职责是将原始的K线（Candlestick）数据转化为缠论理论中标准化的几何结构元素。它是整个体系中缠论分析的基石。



#### 数据结构 (Data Structures)

###### Kline：

经过“包含关系”处理后的标准化K线对象。这是缠论分析的第一步，也是最基础的一步 。  

{ open: float, high: float, low: float, close: float, volume: float, timestamp: int, processed: bool }



###### Fractal (Fx)分型：

{ type: 'top' | 'bottom', kline: Kline, timestamp: int }



###### Stroke (Bi)笔：

{ start_fx: Fractal, end_fx: Fractal, direction: 'up' | 'down', high: float, low: float, klines: List[Kline], macd_area: float, macd_height: float }

macd_area 和 macd_height 是为了后续的背驰计算而预先处理的量化指标 。

  

###### Segment (Duan)段：

{ start_bi: Stroke, end_bi: Stroke, direction: 'up' | 'down', high: float, low: float, strokes: List, contained_zs: List[Center] }

Center (Zhongshu, ZS)：中枢。

{ type: 'bi_zs' | 'seg_zs', high: float, low: float, entry_stroke: Stroke, exit_stroke: Stroke, strokes: List }



#### API函数 (API Functions)

###### process_inclusions(klines: List) -> List[Kline]:

描述: 实现缠论的K线包含关系处理算法，将原始K线序列合并为无包含关系的标准K线序列。

参数: klines - 原始K线数据列表。

返回: 标准化K线列表。



###### find_fractals(processed_klines: List[Kline]) -> List[Fractal]:

描述: 在标准化的K线序列上识别顶分型和底分型。

参数: processed_klines - 经过包含关系处理的K线列表。

返回: 分型对象列表。



###### build_strokes(fractals: List[Fractal], config: Dict) -> List:

描述: 连接分型以构建笔。此函数必须是可配置的，以支持用户指定的不同笔算法，如“老笔”、“新笔”或“严格笔”（类似于4K规则）。  

参数: fractals - 分型列表; config - 包含笔定义规则的配置字典。

返回: 笔对象列表。



###### build_segments(strokes: List, config: Dict) -> List:

描述: 基于笔序列构建线段。同样，此函数应支持不同的线段划分算法，如“特征序列法”或“1+1终结法” 。  

参数: strokes - 笔列表; config - 包含线段定义规则的配置字典。

返回: 线段对象列表。



###### identify_centers(elements: Union, List]) -> List[Center]:

描述: 根据笔或线段序列识别并构建中枢（bi_zs 或 seg_zs）。

参数: elements - 笔列表或线段列表。

返回: 中枢对象列表。



### 1.3 API设计：SMC/ICT流动性与结构模块 (SMCEngine, StructureEngine)

这两个模块负责识别图表上的机构行为概念，为市场行为提供“智能货币”的视角。



#### 数据结构 (Data Structures)



###### LiquidityLevel: 流动性水平。

{ price: float, type: 'bsl' | 'ssl', strength: int, timeframe: str }

bsl (Buyside Liquidity) 和 ssl (Sellside Liquidity) 分别代表买方和卖方流动性 。  

strength 可基于触及次数来量化。



###### POI (Point of Interest): 关键兴趣点。

{ type: 'ob' | 'fvg' | 'breaker_block', high: float, low: float, timeframe: str, mitigated: bool }

ob (Order Block) 指订单块，fvg (Fair Value Gap) 指公允价值缺口 。  



###### MarketStructureEvent: 市场结构事件。

{ type: 'bos' | 'choch' | 'idm', level_type: 'bi' | 'seg' | 'fx', price: float, timestamp: int }

bos (Break of Structure) 指结构突破，choch (Change of Character) 指特征改变，idm (Inducement) 指诱导 。 

 

#### API函数 (SMCEngine)

###### find_liquidity_levels(klines: List[Kline], lookback: int) -> List[LiquidityLevel]:

描述: 识别重要的波段高点（BSL）和波段低点（SSL）作为流动性池 。  

参数: klines - K线列表; lookback - 回看周期。

返回: 流动性水平对象列表。



###### find_order_blocks(klines: List[Kline]) -> List[POI]:

描述: 识别看涨和看跌订单块。通常定义为在强劲推动浪之前的最后一根反向蜡烛 。  

参数: klines - K线列表。

返回: POI对象列表。



###### find_fvgs(klines: List[Kline]) -> List[POI]:

描述: 识别连续三根蜡烛之间产生的公允价值缺口（或称失衡区）。  

参数: klines - K线列表。

返回: POI对象列表。



#### API函数 (StructureEngine)

###### identify_structure_events(elements: Union, List]) -> List:

描述: 这是缠论与SMC理论融合的关键节点。它以缠论的“笔”和“段”作为定义市场结构的基础。例如，一根新的上涨笔突破了前一根上涨笔的高点，可被定义为 bi_bos。一段走势的方向发生根本性改变（如上涨段被一个向下的笔终结），可被定义为 seg_choch。这直接实现了用户对 bi_bos, seg_bos, bi_choch, seg_choch 等组件的量化需求。

参数: elements - 缠论引擎输出的笔或段列表。

返回: 市场结构事件列表。



### 1.4 基础逻辑：关键水平价格行为的量化定义

这是解决用户提出的首要问题的核心，即为“扫荡”、“攫取”和“击穿”提供一个稳健的、可编程的量化框架。现有研究表明，诸如“流动性抓取”（Liquidity Grab）和“流动性扫荡”（Liquidity Sweep）之类的术语，其定义往往是定性的，基于持续时间（如“短暂”对“停留”）或形态（如“长影线”对“实体突破”），这在交易者之间存在主观性，无法直接用于量化系统 。  

这种主观性是量化系统的致命弱点。要解决这个问题，必须引入一个客观的、可量化的维度来判断价格行为背后的“意图”。机构资金的真实意图——是低成本地获取流动性（止损盘），还是高成本地推动价格进入新区间——是区分这些行为的关键 。交易量是衡量市场参与度和资金承诺度的最直接指标。一个由巨大交易量支撑的突破，表明了机构重新定价资产的强烈意愿；而一个在低交易量下发生的突破，则极有可能是为诱捕交易者而设的陷阱 。  

因此，一个有效的量化定义体系必须将价格行为与交易量相结合。此外，这个定义不能是静态的，而必须是相对于近期市场活动的。这意味着交易量阈值不应是一个固定的数值，而应是近期平均交易量的一个倍数（例如，20周期交易量移动平均线的150%）。这使得系统能够自适应不同的市场环境。  

基于以上分析，我们提出以下量化定义框架，该框架将用户术语与精确的、可编程的规则对应起来，构成了整个系统判断组件有效性的基石。



表1：关键水平价格行为的量化定义（以突破波段高点为例）

行为类型            价格行为规则                                            交易量规则（与20周期MA对比）                对组件有效性的影响

Sweep (扫荡)      蜡烛最高价 > 关键水平，但收盘价 < 关键水平 (长上影线刺穿)    非主要因素，但通常为低或中等交易量。        无效突破。关键水平守住。这是一个强烈的反转信号。

Grab (攫取)       蜡烛收盘价 > 关键水平 (实体收盘于水平之上)                  交易量 < 1.5倍 MA (低信念度突破)            潜在无效。应视为流动性抓取或“乌龟汤”形态，直到被后续价格行为证实。不应确认为BOS。

Pierce (击穿)       蜡烛收盘价 > 关键水平                                   交易量 >= 1.5倍 MA (高信念度突破)           有效突破。确认BOS。标志着趋势可能延续。

Export to Sheets



## 第二部分：形态模式识别与集成

本部分的目标是定义具体的算法，用于识别用户指定的交易形态，将缠论的几何分析与SMC的流动性模式进行有机结合。



### 2.1 缠论背驰形态 (背驰)

背驰是缠论中预判第一类买卖点的核心技术。量化背驰的关键在于客观地衡量两段同向走势的“力度”。

现有研究和实践表明，MACD指标是判断背驰最常用的工具 。其中，“MACD面积”的概念为“力度”提供了一个可计算的量度 。标准的MACD计算公式是公开且明确的 。  

#### 算法实现

##### MACD指标计算:

对于ChanlunEngine输出的每一根Stroke (Bi)，首先要计算其对应的MACD指标值。

##### 力度量化:

macd_area (MACD面积): 找出该Bi所对应的MACD柱状图（Histogram）区间（即两次穿越零轴之间的部分），计算该区间内所有柱子高度的绝对值之和。

macd_height (MACD高度): 找出该Bi所对应的MACD快线（MACD Line）的峰值或谷值。



##### 笔背驰 (笔背驰) 判断:

看涨背驰: 比较当前向下的Bi_n与前一根或多根向下的Bi_n-k。如果Bi_n.low < Bi_n-k.low（价格新低），但 Bi_n.macd_area < Bi_n-k.macd_area 或 Bi_n.macd_height > Bi_n-k.macd_height（MACD力度未创新低），则标记为笔背驰。

看跌背驰: 逻辑相反。

多笔背驰与时间衰减: 按照用户要求，算法在判断背驰时，应将当前笔与前序多根同向笔进行比较（如n与n-1, n-2, n-3...）。为了体现“时间衰减”效应，可以为比较结果引入权重递减因子。例如，与紧邻前一笔的背驰得分最高，与更早笔的背驰得分则相应降低。

段背驰 (段背驰) 与盘整/趋势背驰:

相同的逻辑可以应用于Segment (Duan)级别，以判断段背驰。

对于包含中枢的走势，算法需要区分是“盘整背驰”（出中枢笔与入中枢笔比较）还是“趋势背驰”（最后一个中枢的出中枢笔与入中枢笔比较），这需要结合ChanlunEngine识别出的中枢信息进行判断。



### 2.2 SMC流动性形态

此部分旨在将SMC中基于流动性的核心形态进行算法化。



##### 等高/等低点 (EQH/EQL)

算法: 在指定的回看周期内，扫描由SMCEngine识别出的所有波段高点和低点。如果发现两个或多个高点（或低点）的价格处于一个非常小的容差范围（例如，x个最小价格单位或y倍的ATR）内，则将它们标记为一个LiquidityLevel，并将其strength属性设为触及次数 。这些区域是重要的流动性池，是后续“乌龟汤”等形态发生的前提。  

##### “乌龟汤”形态模块 (Turtle Soup)

“乌龟汤”是一种经典的反转策略，专门交易针对关键水平（尤其是EQH/EQL）的假突破 。各方资料对其核心逻辑的描述高度一致：首先在高时间周期（HTF）上确定一个流动性水平，然后在低时间周期（LTF）上观察价格对该水平的扫荡，最后等待LTF的市场结构发生转变作为入场确认 。TradingView上相关的开源脚本为具体实现提供了清晰的模板：价格突破一个波段高/低点后，收盘价回到该水平之内 。  

###### 算法实现 (find_turtle_soup)

输入 (Input): 一个在较高时间周期（如H1, H4）上由SMCEngine识别出的LiquidityLevel，特别是strength > 1的EQH/EQL。

触发 (Trigger): 在执行周期（如M15）上，实时监控价格行为。当价格触及该LiquidityLevel时，使用表1的规则进行判断。

###### 检测到对该水平的 Sweep (扫荡) 或 Grab (攫取)。

一个Grab（实体收盘于水平之外）如果在接下来的1-3根K线内迅速反转，回到水平之内，是一个极强的“乌龟汤”信号。

确认 (Confirmation): 在扫荡或攫取发生后，切换到更低的精确周期（如M1, M5），等待一个明确的MarketStructureEvent，即CHOCH（特征改变）。

看涨乌龟汤: 在扫荡SSL后，等待LTF上价格突破最后一个下跌波段的小时高点，形成看涨CHOCH。

看跌乌龟汤: 在扫荡BSL后，等待LTF上价格跌破最后一个上涨波段的小时低点，形成看跌CHOCH。

输出 (Output): 生成一个高概率的反转交易信号，包含方向、建议入场区域和失效条件。





## 第三部分：集成化多周期分析框架

一个成功的交易系统必须将低时间周期的具体操作置于高时间周期宏大叙事的背景之下。本部分旨在构建一个系统化的、自上而下的分析流程，明确定义四个不同时间周期的角色与信息流，以解决用户对此提出的要求。



### 3.1 定义时间周期角色与信息流

多周期分析是专业交易的核心原则，无论是SMC理论还是其他成熟的交易方法论都对此极为重视 。其基本逻辑是自上而下（Top-Down）的：高周期提供方向偏见，中周期提供交易区域，低周期提供入场时机。  

这种层级关系并非简单的“信号叠加”，而是一种严格的“门控机制”。高时间周期的状态，是低时间周期交易信号是否有效的“守门员”。例如，当H4周期处于强劲的下跌趋势中，并且价格正在一个主要的供给区（Supply Zone）内做出反应时，一个M5周期上出现的看涨CHOCH信号，其意义和可靠性将大打折扣，甚至应被视为一个潜在的陷阱。因此，系统必须在算法层面强制执行这种层级过滤。高周期分析应首先生成一个明确的“方向偏见”状态（例如：'BULLISH', 'BEARISH', 'RANGING'），这个状态将作为后续所有低周期分析的前提条件。

为了将这一理念固化为系统规则，我们设计了以下的多周期角色与信号矩阵。该矩阵清晰地为每个周期分配了特定的任务，为算法的自上而下分析流程提供了明确的“检查清单”。



表2：多周期角色与信号矩阵

时间周期            角色                    核心分析组件                                                        输出 / 偏见

超大周期 (W1/D1)    宏观叙事与主要偏见      主要的seg_zs（段中枢），关键的周/月度高低点，长期趋势线。            整体市场偏见（例如，“牛市，但正在向主要需求区进行深幅回调”）。

大周期 (H4/H1)      方向偏见与关键区域(POI) bi_zs（笔中枢），seg_bos/seg_choch，溢价/折价区，主要的OB/FVG。     当前波段趋势方向（看涨/看跌），并识别出可供交易的HTF POI。

本周期 (M15/M5)     交易设置与确认          bi_bos/bi_choch，价格在HTF POI内的反应，乌龟汤形态，bi_idm（笔诱导）。  确认入场方向，验证交易设置的有效性（如扫荡后的CHOCH）。

次周期 (M1/Sub-M1)  精确入场与风险定义      精炼的FVG/OB入场点，fx_choch（分型特征改变），精细的趋势线。            提供精确的入场价格，并最终定义初始止损位置。

Export to Sheets





## 第四部分：统一的入场、出场与融合评分系统

本部分是整个系统的“大脑”，其目标是将来自缠论和SMC这两个不同理论体系的信号，通过一个量化的评分模型，融合成一个单一的、可执行的、按质量排序的交易决策。



### 4.1 映射缠论与SMC的买卖点

融合的第一步是找到两种理论在逻辑上的共通之处，识别出那些两种理论同时指向同一方向的“共振点”。



##### 缠论一类买卖点 ↔ SMC在POI处反转:

一类买点: 由背驰驱动的下跌终结。其信号强度在以下情况达到最高：当它发生在对一个主要SSL（卖方流动性）的扫荡之后，并且整个过程位于一个HTF（高时间周期）的需求区（如订单块OB或公允价值缺口FVG）之内。

一类卖点: 逻辑相反。



##### 缠论二类买卖点 ↔ SMC在MSS后延续:

二类买点: 一类买点后，首次回调不创新低的点。这在SMC中等同于市场发生CHOCH（特征改变）后的首次回调入场。这个入场点通常是一个新形成的FVG或一个破位区块（Breaker Block）。

二类卖点: 逻辑相反。



##### 缠论三类买卖点 ↔ SMC在BOS后延续:

三类买点: 离开一个上涨中枢后的首次回调，且不重新进入该中枢。这在SMC中等同于市场发生BOS（结构突破）后的回调入场。这个入场点通常位于导致BOS的那个强劲推动浪所创造的POI（OB或FVG）上。

三类卖点: 逻辑相反。



### 4.2 融合评分矩阵

为了量化一个交易设置的“质量”，我们引入一个灵活且强大的评分系统。这个系统的设计灵感来源于专业交易员的“共振 checklist”工作流 。系统将不同的证据（信号）赋予基础分值，并根据其在多周期框架中的位置应用乘数，最终得出一个综合分数。  

#### 评分框架

基础分 (Base Scores): 为独立的信号事件分配一个基础分数。

HTF POI (H4 OB): +2

本周期 CHOCH: +2

缠论 bi_beichi (笔背驰): +3

扫荡主要流动性水平: +3

存在可供入场的 FVG: +1

乘数 (Multipliers): 体现多周期分析的层级门控。

设置与超大周期偏见一致: x1.5

设置与大周期偏见一致: x1.2

设置与大周期偏见相悖: x0.4 (严厉惩罚逆势交易)

时间衰减因子 (Time Decay Factor):

对于缠论背驰，应用衰减因子以体现用户“紧邻前一笔”的偏好。例如: 最终分数 = 基础分 * (0.9 ^ (N-1))，其中N是与当前笔进行比较的笔的序号（N=1代表紧邻前一笔）。



表3：融合评分矩阵（以看涨设置为例）

类别        信号 / 事件             基础分              乘数 / 条件

HTF 背景    与D1偏见一致            N/A                 总分乘数: 1.5

            与H4趋势一致            N/A                 总分乘数: 1.2

流动性      扫荡/攫取 H4 SSL        +3                  

            扫荡/攫取 D1 SSL        +5

结构        M15 CHOCH               +2

            H4 BOS (用于延续形态)   +2

缠论        M15 bi_beichi (笔背驰)  +3                  应用时间衰减因子

            H1 duan_beichi (段背驰) +5                  应用时间衰减因子

POI         在 H4 需求区 (OB) 入场  +2

            在 M15 FVG 入场         +1

决策阈值        总分 > 8            高概率 (可重仓)

                总分 5-7            中概率 (可轻仓测试)

                总分 < 5            无交易

Export to Sheets



### 4.3 动态风险管理与目标设定

#### 止损 (Stop-Loss):

第一止损点: 放置在触发交易的流动性扫荡蜡烛的影线末端之外。

第二止损点 (更安全): 放置在整个POI区域的低点（如订单块的最低点）之外。

在波动性较高的市场中，可以考虑使用基于ATR（平均真实波幅）的动态止损，以给予价格足够的“呼吸空间” 。  



#### 止盈 (Take-Profit):

第一止盈点 (TP1): 本周期图表上最近的、显著的对立流动性水平（例如，下一个重要的BSL）。

第二止盈点 (TP2): 大周期图表上的主要“流动性目标”（Draw on Liquidity），即市场当前正在朝其运行的主要对立流动性池。





## 第五部分：最终系统工作流与完善建议

本部分将整个交易策略流程以清晰的流程图形式呈现，并为系统的未来迭代提出具体的研究和改进方向。

### 5.1 完整的算法策略工作流

初始化: 加载并预处理所有四个时间周期的K线数据。

自上而下分析:

在**超大周期 (D1/W1)**上运行 ChanlunEngine 和 SMCEngine，确定宏观叙事偏见。

在**大周期 (H4/H1)**上运行引擎，确定当前方向偏见，并识别出所有HTF的POI和主要流动性水平。

等待触发: 进入循环监控模式。等待价格进入一个高优先级的HTF POI区域。

本周期分析:

一旦价格进入HTF POI，将分析焦点切换到本周期 (M15/M5)。

使用表1的规则，寻找对本地高/低点的Sweep/Grab行为。

运行PatternRecognizer，检查是否存在乌龟汤形态或缠论背驰。

运行StructureEngine，等待一个确认性的CHOCH事件。

评分设置: 如果确认信号出现，将所有相关事件（HTF背景、扫荡、CHOCH、背驰、POI质量等）打包发送给ConfluenceScorer模块。

执行决策:

ConfluenceScorer根据表3的规则计算出最终得分。

如果总分超过预设阈值，ExecutionManager将根据风险参数（如账户总值的1-2%）计算头寸规模 ，并根据  

4.3节的规则设置初始止损和止盈点，然后下单。

管理头寸: 根据预设的交易管理规则（如移动止损、在TP1部分平仓等）对持仓进行动态管理。



### 5.2 建议的修改与未来研究方向

为了进一步提升系统的性能和稳健性，建议在当前框架基础上进行以下方向的探索和完善：

成交量分布图 (Volume Profile) 集成: 使用成交量分布图来增强POI的有效性。形成于高成交量节点（HVN）的POI具有更强的支撑/阻力。同时，低成交量节点（LVN）可以被识别为价格可能快速穿越的区域，有助于优化止盈目标的设定。

高级背驰确认: 引入RSI指标作为MACD背驰的第二重确认。当MACD和RSI同时出现背驰时，信号的可靠性会显著提高 。  

市场状态过滤 (Regime Filtering): 引入波动率过滤器（如使用ATR或VIX指数）。系统应能识别当前市场是处于高波动还是低波动状态，并据此动态调整策略参数（如止损宽度、交易量阈值等）。

机器学习优化: 利用遗传算法或强化学习等技术，对**融合评分矩阵（表3）**中的权重和阈值进行自动化优化。通过大规模的历史回测，让机器自行发现最具预测能力的信号组合和权重分配。

新闻事件过滤器: 集成一个经济日历API。在重大新闻事件（如非农就业数据、利率决议）发布前后，系统可以自动暂停交易或降低风险敞口，因为这些事件可能导致纯技术分析失效 。  

深化缠论组件: 对缠论中的“走势类型”进行更精细的划分和识别，例如严格区分盘整、上涨和下跌趋势，并为不同走势类型下的买卖点赋予不同的权重。
